<%- include ('header') %>
<%- include ('../../partials/sidebar') %>
<section id="content">
<div class="container">
    <div class="card ">
        <form method="post" role="form" id="profileSubmit" enctype="multipart/form-data">
            <div class="card">
                <div class="card-header">
                    <h2>Edit Profile </h2>
                </div>
                <div class="card-body card-padding">
                    <input type="hidden" name="companyId" id="companyId" value="<%= data.id %>">
                    <div class="form-group fg-line">
                        <p class="f-500 c-black m-b-10">Admin Name <span class="c-red m-l-3" >*</span> </p>
                        <input onchange="return trim(this)" value="<%= data.companyName %>" maxlength="15" placeholder="First Name" class="form-control"  type="text" id="companyName" name="companyName">
                    </div>
                    <div class="form-group fg-line">
                        <p class="f-500 c-black m-b-10">Admin Address <span class="c-red m-l-3" >*</span> </p>
                        <input onchange="return trim(this)" value="<%= data.address1 %>" maxlength="255" placeholder="company Address" class="form-control"  type="text" id="address1" name="address1" >
                        <input type="hidden" name="latitude" value="<%-data.latitude %>" id="latitude" placeholder="Address 1" class="form-control">
                        <input type="hidden" name="longitude" value="<%-data.longitude %>" id="longitude" placeholder="Address 1" class="form-control">
                    </div>
                    <div class="form-group fg-line">
                        <p class="f-500 c-black m-b-10">Admin Email <span class="c-red m-l-3" >*</span> </p>
                        <input onchange="return trim(this)" value="<%= data.email %>" placeholder="First Name" class="form-control"  type="text" id="email" name="email"readonly>
                    </div>
                    <div class="form-group fg-line">
                        <p class="f-500 c-black m-b-15">Choose file to upload Image  <span class="c-red m-l-3" >*</span> </p>
                        <div class="fileinput fileinput-new text-center" data-provides="fileinput">
                            <div class="fileinput-preview thumbnail" data-trigger="fileinput"></div>
                            <div>
                                <span class="btn btn-info btn-file">
                                    <span class="fileinput-new">Upload Icon</span>
                                    <span class="fileinput-exists">Change</span>
                                    <input type="file" id="icon" name="icon">
                                </span>
                                <a href="#" class="btn btn-danger fileinput-exists" data-dismiss="fileinput">Remove</a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group fg-line m-t-20">
                        <button  type="button" onclick="window.history.back();"   class="btn btn-link btn-sm waves-effect">
                           Cancel
                        </button>
                        <button class="btn btn-primary btn-sm waves-effect">Save</button>
                    </div>
                </div>
            </div>
        </form>
 </section>

</section>
 <!-- Modal Default --> 
    <div class="modal fade" id="modalDefault" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Modal title</h4>
                </div>
                <div class="modal-body">
                    <div> <h5 class="text-uppercase">Drag and drop marker to get location</h5>
<div id="map_canvas" style="height:100%;"></div>
</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-link">Save changes</button>
                    <button type="button" class="btn btn-link" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
<!-- google maps api -->
<script src="https://maps.google.com/maps/api/js?key=AIzaSyA7Zj-PTZm4sDG-eoiLPA-XohvgxBe95wU&libraries=places,geometry,drawing&sensor=true"></script>

<%- include ('../../partials/commonJs') %>
    <script>
     $(function() {
  $('#userprofiletab').addClass('active toggled');
  $('#profiledrop').css('display','block');
  $('#profiletab').addClass('active');
});
$("#profileSubmit").validate({
        rules: {
            companyName: {
              required: true
            },
            email: {
              required: true
            },

            address1: {
                required: true
            },
            icon: { accept: "image/jpg,image/jpeg,image/png"},


        },
        messages: {
            companyName: {
                required: "This field is required"
            },
            email: {
                required: "This field is required"
            },
            address1: {
              required: "This field is required"
            },
            icon: {accept: 'Not an image!'},

    
        },
        submitHandler: function (form) {

           
            var tempform = $('#profileSubmit');
            var form_data = new FormData(tempform[0]);
            $.ajax({
                type: 'POST', 
                url: '<%=adminpath %>profile/companyUpdate',
                dataType: 'json',
                data: form_data,
                contentType:false,
                cache:false,
                processData:false,
                success: function (response) {
                    $("#loading1").hide();
                    if (response.code == 200) {
                  
                        showToastSuccess(response.message);
                        setTimeout(function(){
                    window.location.reload();
                }, 2000);
                      
                    } else {
                        showToastError(response.message)
                    }
                },
                error: function(response)
                {
                    $('#loading1').hide()
                   var errorResponse=JSON.parse(response.responseText)
                   showToastError(errorResponse.message)


                }
            });
        
    }

        
    });



        var geocoder;
        var map;
        var marker;
        var infowindow = new google.maps.InfoWindow({
          size: new google.maps.Size(150, 50)
        });

        function initialize() {
            geocoder = new google.maps.Geocoder();
            var latlng = new google.maps.LatLng(30.7046, 76.7179);
            var mapOptions = {
                zoom: 10,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            }
            map = new google.maps.Map(document.getElementById('map_canvas'), mapOptions);
            google.maps.event.addListener(map, 'click', function() {
                infowindow.close();
            });
            var input2 = document.getElementById('address1');
            var autocomplete2 = new google.maps.places.Autocomplete(input2);
            new google.maps.event.addListener(autocomplete2, 'place_changed', function () {
                var place = autocomplete2.getPlace(); 
                var lat2 =  place.geometry.location.lat();
                var lng2 =  place.geometry.location.lng();
                var addressLat2 = lat2.toFixed(6);
                var addressLong2 = lng2.toFixed(6);
                $('#latitude').val(addressLat2);
                $('#longitude').val(addressLong2);

                map.setCenter(place.geometry.location);
                if (marker) {
                    marker.setMap(null);
                    if (infowindow) infowindow.close();
                }
                marker = new google.maps.Marker({
                    map: map,
                    draggable: true,
                    position: place.geometry.location
                });
                google.maps.event.addListener(marker, 'dragend', function() {
                    geocodePosition(marker.getPosition());
                });
            });
            //Pre Defind
            var address = document.getElementById('address1').value;
            geocoder.geocode({
                'address': address
            }, function(results, status) {
                
                if (status == google.maps.GeocoderStatus.OK) {
                  map.setCenter(results[0].geometry.location);
                  if (marker) {
                    marker.setMap(null);
                    if (infowindow) infowindow.close();
                  }
                  marker = new google.maps.Marker({
                    map: map,
                    draggable: true,
                    position: results[0].geometry.location
                  });
                  google.maps.event.addListener(marker, 'dragend', function() {
                    geocodePosition(marker.getPosition());
                  });
                  google.maps.event.addListener(marker, 'click', function() {
                    if (marker.formatted_address) {
                      infowindow.setContent(marker.formatted_address + "<br>coordinates: " + marker.getPosition().toUrlValue(6));
                    } else {
                      infowindow.setContent(address + "<br>coordinates: " + marker.getPosition().toUrlValue(6));
                    }
                    infowindow.open(map, marker);
                  });
                  google.maps.event.trigger(marker, 'click');
                } else {
                  console.log('Geocode was not successful for the following reason: ' + status);
                }
            });
        }

        function geocodePosition(pos) {
            geocoder.geocode({
                latLng: pos
            }, function(responses) {

                if (responses && responses.length > 0) {
                  marker.formatted_address = responses[0].formatted_address;
                } else {
                  marker.formatted_address = 'Cannot determine address at this location.';
                }
                infowindow.setContent(marker.formatted_address + "<br>coordinates: " + marker.getPosition().toUrlValue(6));
                infowindow.open(map, marker);
                var locationaltitude = marker.getPosition().toUrlValue(6);
                var res = locationaltitude.split(",");
                var lat1 = res[0];
                var log2 = res[1];
                $('#address1').val(marker.formatted_address);
                $('#latitude').val(lat1);
                $('#longitude').val(log2);
            });
        }

        google.maps.event.addDomListener(window, "load", initialize);
    </script>

<script>
function trim (el) {
    el.value = el.value.
       replace (/(^\s*)|(\s*$)/gi, ""). // removes leading and trailing spaces
       replace (/[ ]{2,}/gi," ").       // replaces multiple spaces with one space 
       replace (/\n +/,"\n");           // Removes spaces after newlines
    return;
}

</script>
